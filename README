= ruby-prof

== Overview

ruby-prof is a fast code profiler for Ruby.  Its features include:

* Speed - it is a C extension and therefore many times faster than the standard Ruby profiler.
* Flat Profiles - similar to the reports generated by the standard Ruby profiler
* Graph profiles - similar to GProf, these show how long a method runs, which methods call it and which methods it calls.
* Threads - supports profiling multiple threads simultaneously
* Recursive calls - supports profiling recursive method calls
* Reports - can generate both text and cross-referenced html reports
* Output - can output to standard out or to a file


== Requirements

ruby-prof requires Ruby 1.8.2 or higher.

If you are running Linux or Unix you'll need a C compiler so the extension
can be compiled when it is insalled.

If you are running Windows, then install the Windows specific RubyGem which
includes an already built extension.


== Install

ruby-prof is provided as a RubyGem.  To install:

<tt>gem install ruby-prof</tt>


== Usage

There are three ways of running ruby-prof.

=== ruby-prof executable

The first is to use ruby-prof to run the Ruby program
you want to profile.  For more information refer to
the ruby-prof documentation[link:files/bin/ruby-prof.html].

=== ruby-prof API

The second way is to use the ruby-prof API to profile
particular segements of code.  

  require 'ruby-prof'
  
  # Profile the code
  RubyProf.start
  ...
  [code to profile]
  ...
  result = RubyProf.end
  
  # Print a flat profile to text
  printer = RubyProf::TextPrinter.new(result)
  printer.print(STDOUT, 0)
	
Alternatively, you can use a block to tell ruby-prof what
to profile:

  require 'ruby-prof'
  
  # Profile the code
  result = RubyProf.profile do
    ...
    [code to profile]
    ...
  end
  
  # Print a graph profile to text
  printer = RubyProf::GraphPrinter.new(result)
  printer.print(STDOUT, 0)

  
=== require unprof

The third way of using ruby-prof is by requiring unprof.rb:

	require 'unprof'

This will start profiling immediately and will output the results
using a flat profile report.

This method is provided for backwards compatibility.  Using
{ruby-prof}[link:files/bin/ruby-prof.html] provides more flexibility.
  

== Reports

ruby-prof can generate flat profile and graph profile reports.

Flat profiles show the overall time spent in each method.  They
are a good of quickly identifying which methods take the most time.
An example of a flat profile and an explanation can be found in
{examples/flat.txt}[link:files/examples/flat_txt.html].

Graph profiles also show the overall time spent in each method.
In addition, they also show which methods call the current
method and which methods its calls.  Thus they are good for
understanding how methods gets called and provide insight into
the flow of your program.  Graph profiles can be generated
in text and html.  Since the html is cross-referenced it is
easier to work with.  An example text graph profile
is located at {examples/graph.txt}[link:files/examples/graph_txt.html] while
an example html graph file is located at 
{examples/graph.html}[link:files/examples/graph_html.html].

Reports are created by printers.  The current printers include:
* RubyProf::FlatPrinter - Creates a flat report in text format
* RubyProf::GraphPrinter - Creates a call graph report in text format
* RubyProf::GraphHtmlPrinter - Creates a call graph report in HTML (separate files per thread)

To use a printer:

  result = RubyProf.end
  printer = RubyProf::GraphPrinter.new(result)
  printer.print(STDOUT, 0)

The first parameter is any writable IO object such as STDOUT or a file.
The second parameter, which has a default value of 0, specifies 
the minimum percentage a method must take to be printed.  For more
information please see the documentation for the different printers.


== Timing Data

Depending on the mode and platform, ruby-prof measures either process time
or wall time.

Process time measures the time used by a process between any two moments.
It is unaffected by other processes concurrently running 
on the system. Note that Windows does not support measuring process
times - therefore, all measurements on Windows use wall time.

Wall time measures the real-world time elapsed between any two moments.
If there are other processes concurrently running on the system
that use significant CPU or disk time during a profiling run
then the reported results will be too large.

ruby-prof can measure times three different ways:
*clock - Uses the clock method provided by the C runtime library.  This is the default.
*gettimeofday - On Linux uses gettimeofday kernel method while on Windows uses GetLocalTime API.
*cpu - Use the CPU clock counter.  This mode is only supported on Pentium or PowerPC platforms.

On Linux, clock reports process times while gettimeofday and cpu report wall times.
One thing to watch out for on Linux is that clock does not report time spent 
in child processes and does report time spent in Ruby's Kernel.sleep method.  If
you need to measure these values, then use wall time.  On Windows all 
three methods report wall time.

To set the clock_mode:

	RubyProf.clock_mode = RubyProf::CLOCK
	RubyProf.clock_mode = RubyProf::GETTIMEOFDAY
	RubyProf.clock_mode = RubyProf::CPU

You may also specify the clock_mode by using the RUBY_PROF_CLOCK_MODE
environment variable:

	export RUBY_PROF_CLOCK_MODE=clock
	export RUBY_PROF_CLOCK_MODE=gettimeofday
	export RUBY_PROF_CLOCK_MODE=cpu
	
When using CPU time, ruby-prof needs to know the CPU frequency.  On Linux,
it tries to read this value from "/proc/cpuinfo."  On Windows, you must
specify the clock frequency.  This can be done using the
RUBY_PROF_CPU_FREQUENCY environment variable:

	export RUBY_PROF_CPU_FREQUENCY=<value>
	
You can also directly set the cpu_frequency by calling:

	RubyProf.cpu_frequency = <value> 


== Recursive Calls

Recursive calls occur when method A calls method A and cycles
occur when method A calls method B calls method C calls method A.
ruby-prof can detect recursive calls any cycle calls, but does not
currently report these in its output.

However, the self time values for recursive calls should always 
be accurate.  It is also believed that the total times are
accurate, but these should be carefully analyzed to verify their veracity.


== License

See LICENSE for license information.

